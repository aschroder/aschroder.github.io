<!doctype html>
<html lang="en-US">

<!-- Mirrored from www.aschroder.com/2011/06/clustering-wordpress-on-amazon-ec2-micro-instances/comment-page-1/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 30 Aug 2023 22:39:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="../../../../xmlrpc.php">

<title>Clustering Wordpress on Amazon EC2 micro instances | ASchroder.com</title>

<!-- All in One SEO Pack 2.4.2 by Michael Torbert of Semper Fi Web Design[289,368] -->
<meta name="description"  content="It&#039;s a quick and dirty little Wordpress cluster using spot-request micro instances at $0.007/hour - how fun!" />

<meta name="keywords"  content="wordpress,ec2,cluster" />

<!-- /all in one seo pack -->
<link rel='dns-prefetch' href='http://fonts.googleapis.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Feed" href="../../../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Comments Feed" href="../../../../comments/feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Clustering WordPress on Amazon EC2 micro instances Comments Feed" href="../feed/index.html" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v6.2.4 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<script type="text/javascript" data-cfasync="false">
		var disableStr = 'ga-disable-UA-6477134-1';

	/* Function to detect opted out users */
	function __gaTrackerIsOptedOut() {
		return document.cookie.indexOf(disableStr + '=true') > -1;
	}

	/* Disable tracking if the opt-out cookie exists. */
	if ( __gaTrackerIsOptedOut() ) {
		window[disableStr] = true;
	}

	/* Opt-out function */
	function __gaTrackerOptout() {
	  document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
	  window[disableStr] = true;
	}
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','http://www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-6477134-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	__gaTracker('send','pageview');
</script>
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.aschroder.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.8.15"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,56826,8203,55356,56819),0,0),c=j.toDataURL(),b!==c&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55358,56794,8205,9794,65039),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55358,56794,8203,9794,65039),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='yarppWidgetCss-css'  href='../../../../wp-content/plugins/yet-another-related-posts-plugin/style/widget101e.css?ver=4.8.15' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='../../../../wp-content/plugins/wp-syntax/css/wp-syntax4963.css?ver=1.1' type='text/css' media='all' />
<link rel='stylesheet' id='storefront-style-css'  href='../../../../../cdn.aschroder.com/wp-content/themes/storefront/style5bf8.css?ver=2.2.5' type='text/css' media='all' />
<style id='storefront-style-inline-css' type='text/css'>

			.main-navigation ul li a,
			.site-title a,
			ul.menu li a,
			.site-branding h1 a,
			.site-footer .storefront-handheld-footer-bar a:not(.button),
			button.menu-toggle,
			button.menu-toggle:hover {
				color: #333333;
			}

			button.menu-toggle,
			button.menu-toggle:hover {
				border-color: #333333;
			}

			.main-navigation ul li a:hover,
			.main-navigation ul li:hover > a,
			.site-title a:hover,
			a.cart-contents:hover,
			.site-header-cart .widget_shopping_cart a:hover,
			.site-header-cart:hover > li > a,
			.site-header ul.menu li.current-menu-item > a {
				color: #838383;
			}

			table th {
				background-color: #f8f8f8;
			}

			table tbody td {
				background-color: #fdfdfd;
			}

			table tbody tr:nth-child(2n) td,
			fieldset,
			fieldset legend {
				background-color: #fbfbfb;
			}

			.site-header,
			.secondary-navigation ul ul,
			.main-navigation ul.menu > li.menu-item-has-children:after,
			.secondary-navigation ul.menu ul,
			.storefront-handheld-footer-bar,
			.storefront-handheld-footer-bar ul li > a,
			.storefront-handheld-footer-bar ul li.search .site-search,
			button.menu-toggle,
			button.menu-toggle:hover {
				background-color: #ffffff;
			}

			p.site-description,
			.site-header,
			.storefront-handheld-footer-bar {
				color: #6d6d6d;
			}

			.storefront-handheld-footer-bar ul li.cart .count,
			button.menu-toggle:after,
			button.menu-toggle:before,
			button.menu-toggle span:before {
				background-color: #333333;
			}

			.storefront-handheld-footer-bar ul li.cart .count {
				color: #ffffff;
			}

			.storefront-handheld-footer-bar ul li.cart .count {
				border-color: #ffffff;
			}

			h1, h2, h3, h4, h5, h6 {
				color: #333333;
			}

			.widget h1 {
				border-bottom-color: #333333;
			}

			body,
			.secondary-navigation a,
			.onsale,
			.pagination .page-numbers li .page-numbers:not(.current), .woocommerce-pagination .page-numbers li .page-numbers:not(.current) {
				color: #6d6d6d;
			}

			.widget-area .widget a,
			.hentry .entry-header .posted-on a,
			.hentry .entry-header .byline a {
				color: #9f9f9f;
			}

			a  {
				color: #0228d1;
			}

			a:focus,
			.button:focus,
			.button.alt:focus,
			.button.added_to_cart:focus,
			.button.wc-forward:focus,
			button:focus,
			input[type="button"]:focus,
			input[type="reset"]:focus,
			input[type="submit"]:focus {
				outline-color: #0228d1;
			}

			button, input[type="button"], input[type="reset"], input[type="submit"], .button, .added_to_cart, .widget a.button, .site-header-cart .widget_shopping_cart a.button {
				background-color: #eeeeee;
				border-color: #eeeeee;
				color: #333333;
			}

			button:hover, input[type="button"]:hover, input[type="reset"]:hover, input[type="submit"]:hover, .button:hover, .added_to_cart:hover, .widget a.button:hover, .site-header-cart .widget_shopping_cart a.button:hover {
				background-color: #d5d5d5;
				border-color: #d5d5d5;
				color: #333333;
			}

			button.alt, input[type="button"].alt, input[type="reset"].alt, input[type="submit"].alt, .button.alt, .added_to_cart.alt, .widget-area .widget a.button.alt, .added_to_cart, .widget a.button.checkout {
				background-color: #333333;
				border-color: #333333;
				color: #ffffff;
			}

			button.alt:hover, input[type="button"].alt:hover, input[type="reset"].alt:hover, input[type="submit"].alt:hover, .button.alt:hover, .added_to_cart.alt:hover, .widget-area .widget a.button.alt:hover, .added_to_cart:hover, .widget a.button.checkout:hover {
				background-color: #1a1a1a;
				border-color: #1a1a1a;
				color: #ffffff;
			}

			.pagination .page-numbers li .page-numbers.current, .woocommerce-pagination .page-numbers li .page-numbers.current {
				background-color: #e6e6e6;
				color: #6d6d6d;
			}

			#comments .comment-list .comment-content .comment-text {
				background-color: #f8f8f8;
			}

			.site-footer {
				background-color: #f0f0f0;
				color: #6d6d6d;
			}

			.site-footer a:not(.button) {
				color: #333333;
			}

			.site-footer h1, .site-footer h2, .site-footer h3, .site-footer h4, .site-footer h5, .site-footer h6 {
				color: #333333;
			}

			#order_review {
				background-color: #ffffff;
			}

			#payment .payment_methods > li .payment_box,
			#payment .place-order {
				background-color: #fafafa;
			}

			#payment .payment_methods > li:not(.woocommerce-notice) {
				background-color: #f5f5f5;
			}

			#payment .payment_methods > li:not(.woocommerce-notice):hover {
				background-color: #f0f0f0;
			}

			@media screen and ( min-width: 768px ) {
				.secondary-navigation ul.menu a:hover {
					color: #868686;
				}

				.secondary-navigation ul.menu a {
					color: #6d6d6d;
				}

				.site-header-cart .widget_shopping_cart,
				.main-navigation ul.menu ul.sub-menu,
				.main-navigation ul.nav-menu ul.children {
					background-color: #f0f0f0;
				}

				.site-header-cart .widget_shopping_cart .buttons,
				.site-header-cart .widget_shopping_cart .total {
					background-color: #f5f5f5;
				}

				.site-header {
					border-bottom-color: #f0f0f0;
				}
			}
</style>
<link rel='stylesheet' id='storefront-icons-css'  href='../../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/sass/base/icons5bf8.css?ver=2.2.5' type='text/css' media='all' />
<link rel='stylesheet' id='storefront-fonts-css'  href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,300italic,400italic,600,700,900&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<script type='text/javascript' src='../../../../../cdn.aschroder.com/wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../../../../cdn.aschroder.com/wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='../../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Export New Zealand Finalist: World Wide Access, and I&#8217;m on the FM!' href='../../export-new-zealand-finalist-world-wide-access-and-im-on-the-fm/index.html' />
<link rel='next' title='SMTP Pro with Magento: A sort-of user guide.' href='../../smtp-pro-with-magento-a-sort-of-user-guide/index.html' />
<meta name="generator" content="WordPress 4.8.15" />
<link rel="canonical" href="index.html#comments" />
<link rel='shortlink' href='../../../../indexb95d.html?p=1513' />
<link rel="alternate" type="application/json+oembed" href="../../../../wp-json/oembed/1.0/embed9e4d.json?url=http%3A%2F%2Fwww.aschroder.com%2F2011%2F06%2Fclustering-wordpress-on-amazon-ec2-micro-instances%2F" />
<link rel="alternate" type="text/xml+oembed" href="../../../../wp-json/oembed/1.0/embed1b0b?url=http%3A%2F%2Fwww.aschroder.com%2F2011%2F06%2Fclustering-wordpress-on-amazon-ec2-micro-instances%2F&amp;format=xml" />
</head>

<body class="post-template-default single single-post postid-1513 single-format-standard no-wc-breadcrumb storefront-full-width-content right-sidebar">


<div id="page" class="hfeed site">
	
	<header id="masthead" class="site-header" role="banner" style="">
		<div class="col-full">

					<a class="skip-link screen-reader-text" href="#site-navigation">Skip to navigation</a>
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
				<div class="site-branding">
			<div class="beta site-title"><a href="../../../../index.html" rel="home">ASchroder.com</a></div><p class="site-description">Notes on Web Development</p>		</div>
		<div class="storefront-primary-navigation">		<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Navigation">
		<button class="menu-toggle" aria-controls="site-navigation" aria-expanded="false"><span>Menu</span></button>
			<div class="primary-navigation"><ul id="menu-main-menu" class="menu"><li id="menu-item-1119" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1119"><a href="../../../../index.html">Home</a></li>
<li id="menu-item-1118" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1118"><a href="../../../../about/index.html">About</a></li>
<li id="menu-item-1872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1872"><a href="../../../../presentations/index.html">Presentations</a></li>
</ul></div><div class="handheld-navigation"><ul id="menu-main-menu-1" class="menu"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1119"><a href="../../../../index.html">Home</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1118"><a href="../../../../about/index.html">About</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1872"><a href="../../../../presentations/index.html">Presentations</a></li>
</ul></div>		</nav><!-- #site-navigation -->
		</div>
		</div>
	</header><!-- #masthead -->

	
	<div id="content" class="site-content" tabindex="-1">
		<div class="col-full">

		
	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
<div id="post-1513" class="post-1513 post type-post status-publish format-standard hentry category-php category-web-development tag-amazon tag-cluster tag-ec2 tag-wordpress">

			<header class="entry-header">
		<span class="posted-on">Posted on <a href="../index.html" rel="bookmark"><time class="entry-date published" datetime="2011-06-28T02:47:42+00:00">June 28, 2011</time> <time class="updated" datetime="2012-03-13T14:55:47+00:00">March 13, 2012</time></a></span><h1 class="entry-title">Clustering WordPress on Amazon EC2 micro instances</h1>		</header><!-- .entry-header -->
				<aside class="entry-meta">
						<div class="author">
				<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' /><div class="label">Written by</div><a href="../../../../author/admin/index.html" title="Posts by Ashley" rel="author">Ashley</a>			</div>
							<div class="cat-links">
					<div class="label">Posted in</div><a href="../../../../category/php/index.html" rel="category tag">PHP</a>, <a href="../../../../category/web-development/index.html" rel="category tag">Web Development</a>				</div>
			
							<div class="tags-links">
					<div class="label">Tagged</div><a href="../../../../tag/amazon/index.html" rel="tag">amazon</a>, <a href="../../../../tag/cluster/index.html" rel="tag">cluster</a>, <a href="../../../../tag/ec2/index.html" rel="tag">ec2</a>, <a href="../../../../tag/wordpress/index.html" rel="tag">wordpress</a>				</div>
			
		
							<div class="comments-link">
					<div class="label">Comments</div>					<span class="comments-link"><a href="../index.html#comments">28 Comments</a></span>
				</div>
					</aside>
				<div class="entry-content">
		<p>If you are reading this, you are an unwitting participant in my latest experiment: clustering my blog on Amazon EC2 &#8211; thanks! You will be connecting to my blog on one of several Amazon EC2 micro instances, cobbled together in a quick and dirty solution that was more knee-jerk reaction to some downtime, than well thought out project.</p>
<p>This post serves as a chance for me to test if the cluster works, and a summary of the architecture I have set up using several <a href="http://aws.amazon.com/ec2/instance-types/">EC2 micro instances</a> and <a href="http://wordpress.org/">WordPress</a>. It&#8217;s a quick and dirty little WordPress cluster using spot-request micro instances at $0.007/hour &#8211; how fun!<br />
<span id="more-1513"></span></p>
<h3>A bit of background</h3>
<p>I&#8217;m pretty sure I&#8217;m not the only computer nerd who wakes up in the morning and checks their emails first thing. This weekend just gone I had a rather rude awakening because my site was down and I had a <a href="../../../../../monitor.aschroder.com/index.html">slew of down alerts in my inbox</a>. There is little more embarrassing for a computer nerd than a dead blog. Not to mention the implications of a search engine bot finding a broken site. </p>
<p>The EC2 micro instances are a bit <em>flakey</em>, but <a href="http://aws.amazon.com/ec2/pricing/">at 2c/hour they&#8217;re awesome</a> and if you go for the spot instances you can actually get the <a href="http://aws.amazon.com/ec2/pricing/">for as little as 0.7c/hour</a>! </p>
<p>The problem with a single micro instance was my site was going down when it came under sustained load on seldom visited pages. The <a href="http://gregsramblings.com/2011/02/07/amazon-ec2-micro-instance-cpu-steal/">CPU get&#8217;s capped after some (short) amount of time</a>. This hardly ever happens when normal humans are visiting because they tend to visit pages that other people visit, thus they get served a fast cached version. But when a (arguably badly behaved) crawler starts hitting really old posts from the archive, one after the other, several times/second &#8211; things get bogged down, and once the CPU cap comes down, there&#8217;s no recovery as the requests just pile up.</p>
<p>This is not the first time it&#8217;s happened and I really wanted to fix it in a future proof, albeit quick and dirty manner.</p>
<p>In hindsight the cheapest option would have been to just bump the size of my instance type up to the next level and pay a lot more money each month, given how long I spent mucking around with this. But I wanted to try and keep using the micro instances because I really like the concept &#8211; and I had wanted to try the spot instance requests for a while too. So this was a chance to do all of that.</p>
<h3>The Solution</h3>
<p>The requirements were quite simple really:</p>
<ul>
<li>Keep the filesystem in sync, for example when I upload a screenshot, or change a stylesheet</li>
<li>Keep the DB in sync, when a user posts a comment on node 1, people on node 2,3,&#8230;,N need to see it</li>
<li>Allow nodes to be added/removed without affecting the site</li>
<li>Fallback to status quo, or bigger instance if it fails entirely</li>
<li>Tolerate the spot-instances terminating if the price gets high</li>
<li><strong>Update:</strong> Basic PHP session support &#8211; some plugins start PHP sessions, even though core WordPress doesn&#8217;t use them.</li>
</ul>
<p>Non-requirements:</p>
<ul>
<li>Very high fault tolerance; down time is <em>OK</em>, data loss of a few hours would be <em>OK</em> &#8211; no need for master/slaving mysql.</li>
<li>Complete automation (at least not initially); I need to get a feel for how stable it is and where it breaks first.</li>
<li>Redundant points of failure; I&#8217;m hosting it 100% on Amazon, if they let me down, <em>they let me down</em>.</li>
<li><del datetime="2011-06-29T06:42:50+00:00">Sessions &#8211; <a href="http://wordpress.org/support/topic/how-does-wordpress-handle-sessions-and-session-variables">WP doesn&#8217;t use them, as such</a> so no need to replicate them (<a href="http://magebase.com/magento-tutorials/magento-session-storage-which-to-choose-and-why/">unlike Magento</a>).</del></li>
</ul>
<p>So here&#8217;s what I did:</p>
<p><strong>Overview</strong></p>
<p>Before I started I drew a crude picture of how the cluster will look:</p>
<p><img src="../../../../../cdn.aschroder.com/wp-content/uploads/2011/06/elegant-drawing.jpg" alt="Wordpress+Amazon EC2 cluster overview" title="Wordpress+Amazon EC2 cluster overview" width="400" height="377" class="aligncenter size-full wp-image-1525" srcset="http://cdn.aschroder.com/wp-content/uploads/2011/06/elegant-drawing.jpg 400w, http://cdn.aschroder.com/wp-content/uploads/2011/06/elegant-drawing-300x282.jpg 300w" sizes="(max-width: 400px) 100vw, 400px" /></p>
<p>It helped me to know what various technology would be required, and it might help you to understand the basic layout of the cluster.</p>
<p><strong>Load Balancing</strong></p>
<p>This is all possible thanks to the Amazon ELB. It balances traffic evenly across the nodes in the cluster, and if it detects unhealthy ones, it will move them out of the cluster until they return to health. This is the vital part of it, because it means if one of the micro instances suffers the <em>CPU cap of doom</em>, it will get taken out of the cluster, where it can recover with no traffic for a minute and then automatically be put back in.</p>
<p><strong>Data Sharing</strong></p>
<p>This turned out to be very easy, I changed mysql to bind on the internal interface of the master node(instead of localhost), but locked down access to it to only EC2 instances in the cluster. All the nodes in the slave simply point the WordPress install to the <a href="http://aws.amazon.com/articles/Amazon-EC2/1346">elastic IP</a> of the master node, and when an EC2 server resolves an elastic IP, they get the internal network interface, not the external one.</p>
<p><strong>Update:</strong> Heiko <a href="index.html#comment-3562">quite rightly noted</a> this section is a bit vague, here&#8217;s some more info:</p>
<p>Each elastic IP in AWS has it&#8217;s public IP and also a private internal network IP. </p>
<p>For example: <code>ec2-50-17-231-95.compute-1.amazonaws.com</code></p>
<p>If I resolve the IP from my mac laptop at the office:<br />
(Note: we&#8217;ll use <code>ping</code>, <code>dig</code> output is too messy for my blog post!)</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">~ ashley$ <span style="color: #c20cb9; font-weight: bold;">ping</span> ec2-<span style="color: #000000;">50</span>-<span style="color: #000000;">17</span>-<span style="color: #000000;">231</span>-<span style="color: #000000;">95</span>.compute-<span style="color: #000000;">1</span>.amazonaws.com
PING ec2-<span style="color: #000000;">50</span>-<span style="color: #000000;">17</span>-<span style="color: #000000;">231</span>-<span style="color: #000000;">95</span>.compute-<span style="color: #000000;">1</span>.amazonaws.com <span style="color: #7a0874; font-weight: bold;">&#40;</span>50.17.231.95<span style="color: #7a0874; font-weight: bold;">&#41;</span>: <span style="color: #000000;">56</span> data bytes</pre></td></tr></table><p class="theCode" style="display:none;">~ ashley$ ping ec2-50-17-231-95.compute-1.amazonaws.com
PING ec2-50-17-231-95.compute-1.amazonaws.com (50.17.231.95): 56 data bytes</p></div>

<p>But if I resolve it from an AWS server:</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">~$ <span style="color: #c20cb9; font-weight: bold;">ping</span> ec2-<span style="color: #000000;">50</span>-<span style="color: #000000;">17</span>-<span style="color: #000000;">231</span>-<span style="color: #000000;">95</span>.compute-<span style="color: #000000;">1</span>.amazonaws.com
PING ec2-<span style="color: #000000;">50</span>-<span style="color: #000000;">17</span>-<span style="color: #000000;">230</span>-<span style="color: #000000;">94</span>.compute-<span style="color: #000000;">1</span>.amazonaws.com <span style="color: #7a0874; font-weight: bold;">&#40;</span>10.202.51.192<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000;">56</span><span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">84</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> bytes of data.</pre></td></tr></table><p class="theCode" style="display:none;">~$ ping ec2-50-17-231-95.compute-1.amazonaws.com
PING ec2-50-17-230-94.compute-1.amazonaws.com (10.202.51.192) 56(84) bytes of data.</p></div>

<p>So knowing that, and knowing that the elastic DNS never changes, even if we stop and start and fiddle with the master node &#8211; then in our wordpress DB config, when it asks for the Host name of the DB server, instead of using the local IP <code>10.202.51.192</code>, we use the Elastic DNS <code>ec2-50-17-231-95.compute-1.amazonaws.com</code>. </p>
<p>Your WordPress config then might look like this:</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="php" style="font-family:monospace;">&nbsp;
<span style="color: #666666; font-style: italic;">//&lt;snip&gt;</span>
<span style="color: #990000;">define</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'DB_NAME'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'dbname'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">// The name of the database</span>
<span style="color: #990000;">define</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'DB_USER'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'dbuser'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     <span style="color: #666666; font-style: italic;">// Your MySQL username</span>
<span style="color: #990000;">define</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'DB_PASSWORD'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'dbpasswd'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// ...and password</span>
<span style="color: #990000;">define</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'DB_HOST'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'ec2-50-17-231-95.compute-1.amazonaws.com'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">// 99% chance you won't need to change this value</span>
<span style="color: #666666; font-style: italic;">//&lt;/snip&gt;</span></pre></td></tr></table><p class="theCode" style="display:none;">
//&lt;snip&gt;
define('DB_NAME', 'dbname');    // The name of the database
define('DB_USER', 'dbuser');     // Your MySQL username
define('DB_PASSWORD', 'dbpasswd'); // ...and password
define('DB_HOST', 'ec2-50-17-231-95.compute-1.amazonaws.com');    // 99% chance you won't need to change this value
//&lt;/snip&gt;</p></div>

<p>Now note this is the config on the master node&#8217;s web root, because it&#8217;s exported to all the child nodes &#8211; so all copies of the wordpress site use the same config. Change it on the master and they all update.</p>
<p>The same config setup works for EC2 sites running Magento, or any other app too. Hope that makes this section a bit clearer.</p>
<p><strong>File Sharing</strong></p>
<p>It is important that each slave node in the cluster is looking at the same files, for example if I added a new screenshot through the admin while on one of the nodes, the others would all need to see it (at least until <a href="http://aws.amazon.com/cloudfront/">CloudFront adds it to the CDN network</a> I use).</p>
<p>My solution here is NFS, I know that&#8217;s not the highest performance option, but it really made things simple, and seeing as the goal was quick and dirty, I went with it. Security is provided thanks to the EC2 security groups, so only nodes in the ELB can connect to the NFS server.</p>
<p>I suggest using the soft mount option on the clients, so that if the master hiccups, once it&#8217;s responding again the clients pick up the connection easily. I had trouble with hard mounting the NFS, the clients become unresponsive, even when the server was running properly again.</p>
<p><strong>Data Safety</strong></p>
<p>I use <a href="http://alestic.com/2010/10/ec2-consistent-snapshot-035">Eric Hammonds awesome EC2 consistent snapshot</a> as a cron job, this takes a snapshot of the master node every N hours (where N is the amount of data I&#8217;m willing to lose). This way the most recent snapshot can simply be used to start up a replacement master node. Yes initially that would cause downtime, but it _could_ be scripted if it happens regularly, it shouldn&#8217;t.</p>
<p><strong>Spot instances</strong></p>
<p>The spot instances can disappear if the bid price gets too high, so I needed the cluster to be able to handle that. Firstly, the load balancer will stop routing traffic to the nodes if they go down, but it meant I couldn&#8217;t rely only on spot instances &#8211; if they all went away there would be none in the cluster.</p>
<p>My solution was to stump up the 2c/hour for one on-demand slave node, think of it as the &#8216;last stand&#8217;. If the spot price goes too high and all the spot instances terminate, this one lone ranger has to hold out until I either bid more, or the price comes back down and the spot instances restart.</p>
<p><strong>PHP Sessions</strong></p>
<p><strong>Update:</strong> Oops, seems like core WordPress does not need session support, but some plugins, e.g. <a href="http://www.instinct.co.nz/e-commerce/">wp-ecommerce</a>, do. So it&#8217;s best if you use any such plugins, or don&#8217;t want to risk it that you also allow sessions to be shared among the nodes. Thankfully this is easy.</p>
<p>PHP by default stores it&#8217;s sessions on disk, in <code>/tmp</code>. We simply tell it, on a per-site basis, or globally, to store it&#8217;s sessions inside our NFS mounted area like so.</p>
<p>On a per-site basis use the .htaccess file:</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">php_value session.save_path <span style="color: #ff0000;">&quot;/path/to/your/nfs-share/tmp&quot;</span></pre></td></tr></table><p class="theCode" style="display:none;">php_value session.save_path &quot;/path/to/your/nfs-share/tmp&quot;</p></div>

<p>Or for all sites on the server use the php.ini:</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="ini" style="font-family:monospace;">session.save_path <span style="color: #000066; font-weight:bold;">=</span> <span style="color: #933;">&quot;/path/to/your/nfs-share/tmp&quot;</span></pre></td></tr></table><p class="theCode" style="display:none;">session.save_path = &quot;/path/to/your/nfs-share/tmp&quot;</p></div>

<p><strong>Fallback</strong></p>
<p>The master node is a slightly specialized version of the slave nodes, so it does have Apache on it. If it all turns to custard &#8211; I&#8217;ll simply stop the master, change it to a large instance and fire it back up behind the ELB &#8211; I&#8217;ll be back to where I started just with a bigger instance type.</p>
<h3>Results/Conclusion</h3>
<p>I&#8217;m monitoring the micro-cluster closely over the next few days, and will update here with what I find. I created a couple of <a href="http://aws.amazon.com/cloudwatch/">cloudwatch</a> alarms so I can check on things. If these fire too often I&#8217;ll need to add <a href="http://aws.amazon.com/autoscaling/">autoscaling</a> to terminate and restart the spot instances if the become unhealthy. For now I&#8217;m hoping it will occur infrequently or not at all.</p>
<p><img src="../../../../../cdn.aschroder.com/wp-content/uploads/2011/06/Screen-shot-2011-06-28-at-9.32.56-PM.png" alt="AWS Cloudwatch alarms" title="AWS Cloudwatch alarms" width="490" height="176" class="aligncenter size-full wp-image-1517" srcset="http://cdn.aschroder.com/wp-content/uploads/2011/06/Screen-shot-2011-06-28-at-9.32.56-PM.png 490w, http://cdn.aschroder.com/wp-content/uploads/2011/06/Screen-shot-2011-06-28-at-9.32.56-PM-300x107.png 300w" sizes="(max-width: 490px) 100vw, 490px" /></p>
<p>I know the NFS connection is flakey, but it&#8217;s a very simple way of keeping things like css/plugins/cached files in sync across the nodes. If anyone has a better suggestion, I&#8217;d like to hear it.</p>
<p>For performance testing, I used a slightly modified version of my <a href="http://www.magespeedtest.com/">magento performance testing</a> site to test the new WordPress cluster set-up. It <a href="http://twitter.com/#!/beriberikix/status/85148768948858882">occurred to me</a> that the performance testing I do on magespeedtest.com could be good for other CMS&#8217;s &#8211; any feedback on the idea of a wordpress/joomla/$cms speed test tool? </p>
<p>Anyway, the results were pleasing:</p>
<blockquote><p>129.98 trans/sec @ 0.28 secs each </p></blockquote>
<p>If I get that much real traffic, I&#8217;ll be signing up for adwords before fixing my blog!</p>
<p>In conclusion, I hope this little guide to WordPress clustering on EC2 is interesting, I can&#8217;t with a straight face recommend you go and implement this yourself <em>just yet</em>, but once I have more experience with it, I&#8217;ll let you know. I would love any ideas or feedback on improving this setup.</p>
<p>One thing that has become clear, EC2 is a powerful infrastructure building block, which really underpins this entire project &#8211; it has really blazed a trail and I look forward to more innovation from the AWS team.</p>
<p><em>First experience update &#8211; after 1 day</em>: Well, I lost one node on the first day. A random patch of NFS flakiness took it right out mid-way through reading, Apache stopped responding, reboots would not complete, it was well dead. Solution: terminate it, remove it from the cluster and the spot request will fire up a new one, which get&#8217;s added to the cluster.</p>
<p>If this happens frequently I will write a short script to automatically terminate long-unhealthy instances, and add their replacements to the cluster.</p>
<p><em>Second experience update &#8211; after 1 month</em>: Geez has it been a whole month?! The cluster has been rock solid the whole time, no downtime &#8211; not even a single node failure since that first one the day after I launched it. I checked the CPU usage across the cluster and it hardly ever spikes for more than a few seconds. There is a lot of network traffic between the nodes, due to the NFS &#8211; but with EC2 the between instances data transfer is free and fast. So far, so good.</p>
<p><em>Months later update </em>: I wrote a <a href="../../../../2012/01/using-aws-auto-scaling-with-an-elastic-load-balancer-cluster-on-ec2/index.html">follow up to this, autoscaling the cluster</a>. It makes the cluster a lot more reliable, and entirely hands off. You should read it.</p>
<div class='yarpp-related'>
<p>You might also be interested in:<ol>
<li><a href="../../../../2013/01/updating-your-aws-auto-scaling-ami-to-a-new-version/index.html" rel="bookmark" title="Updating your AWS Auto-Scaling AMI to a new version">Updating your AWS Auto-Scaling AMI to a new version </a></li>
<li><a href="../../../../2012/01/using-aws-auto-scaling-with-an-elastic-load-balancer-cluster-on-ec2/index.html" rel="bookmark" title="Using AWS Auto Scaling with an Elastic Load Balancer cluster on EC2">Using AWS Auto Scaling with an Elastic Load Balancer cluster on EC2 </a></li>
<li><a href="../../../../2010/06/wordpress-blank-page-after-posting-comments-and-akismet/index.html" rel="bookmark" title="WordPress: Blank page after posting comments and Akismet">WordPress: Blank page after posting comments and Akismet </a></li>
<li><a href="../../../../2013/04/actually-running-magento-on-amazons-elastic-beanstalk-cloud-platform/index.html" rel="bookmark" title="Actually running Magento on Amazon&#8217;s Elastic Beanstalk Cloud platform">Actually running Magento on Amazon&#8217;s Elastic Beanstalk Cloud platform </a></li>
<li><a href="../../../05/magento-and-amazons-cloudfront-cdn-the-easy-way/index.html" rel="bookmark" title="Magento and Amazon&#8217;s CloudFront CDN &#8211; The Easy Way">Magento and Amazon&#8217;s CloudFront CDN &#8211; The Easy Way </a></li>
</ol></p>
</div>
		</div><!-- .entry-content -->
		<nav id="post-navigation" class="navigation post-navigation" role="navigation" aria-label="Post Navigation"><span class="screen-reader-text">Post navigation</span><div class="nav-links"><div class="nav-previous"><a href="../../export-new-zealand-finalist-world-wide-access-and-im-on-the-fm/index.html" rel="prev">Export New Zealand Finalist: World Wide Access, and I&#8217;m on the FM!</a></div><div class="nav-next"><a href="../../smtp-pro-with-magento-a-sort-of-user-guide/index.html" rel="next">SMTP Pro with Magento: A sort-of user guide.</a></div></div></nav>
<section id="comments" class="comments-area" aria-label="Post Comments">

			<h2 class="comments-title">
			28 thoughts on &ldquo;<span>Clustering WordPress on Amazon EC2 micro instances</span>&rdquo;		</h2>

		
		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-2408">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9c8caa666bc8caf5b4e5625c610c02ee?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9c8caa666bc8caf5b4e5625c610c02ee?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ken</cite>			</div>
			
			<a href="index.html#comment-2408" class="comment-date">
				<time datetime="2011-06-28T05:53:23+00:00">June 28, 2011</time>			</a>
		</div>
				<div id="div-comment-2408" class="comment-content">
				<div class="comment-text">
		<p>Cold try pingdom.com for site monitoring. free 20 SMS credits and nice dashboard status page. We moved to similar architect at tomizone. We use s3fs for the sharing file report from db server to the app server, its slow and occasionally drop connection, will give NFS a try when I have time. ELB really good for website traffic use case, The problem I got is we cant retrieve its IP at the time I try,  we cant get it go pass the wall garden.</p>
<p>When I can test my blog with you modified magento performance testing?^^</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2409">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/76c95c8e802bdd03ff3532d7ea696dcd?s=128&amp;d=mm&amp;r=g' srcset="http://1.gravatar.com/avatar/76c95c8e802bdd03ff3532d7ea696dcd?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">J.T.</cite>			</div>
			
			<a href="index.html#comment-2409" class="comment-date">
				<time datetime="2011-06-28T06:02:10+00:00">June 28, 2011</time>			</a>
		</div>
				<div id="div-comment-2409" class="comment-content">
				<div class="comment-text">
		<p>I&#8217;m thinking of putting a link to your blog, particularly this post, on the Wikipedia article about nerds&#8230;</p>
<p>As for NFS, why not use Rackspace Cloudfiles? Simple APIs (probably an existing WorldPress, possibly under their previous name Mosso), dirt cheap and you get infinite data redundancy, plus of course the benefits of CDN.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2410">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/f26d062d9ba4e31169ddfb8904920ae2?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/f26d062d9ba4e31169ddfb8904920ae2?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Sven</cite>			</div>
			
			<a href="index.html#comment-2410" class="comment-date">
				<time datetime="2011-06-28T06:35:23+00:00">June 28, 2011</time>			</a>
		</div>
				<div id="div-comment-2410" class="comment-content">
				<div class="comment-text">
		<p>Hi Ashley, how are you?</p>
<p>Regarding file sharing between nodes: IMHO is NFS + any HTTP accelerator solution (like Varnish oder Amazon&#8217;s CloudFront) a very simple and easy to handle setup. NFS nerver get&#8217;s loaded, even when flushing all objects in cache.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-2411">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-2411" class="comment-date">
				<time datetime="2011-06-28T11:44:04+00:00">June 28, 2011</time>			</a>
		</div>
				<div id="div-comment-2411" class="comment-content">
				<div class="comment-text">
		<p>@Sven &#8211; thanks for stopping by! I&#8217;ll give Varnish a go and report back on my findings.</p>
<p>@J.T. I&#8217;m sure there are more nerdy people you could reference 🙂 I already use Cloudfront CDN for most files (check the images they should come off cdn.aschroder.com). But the issue is making sure all nodes can see the files (e.g new plugin file or template update). I think NFS would be faster, but I&#8217;ll try it out. The Amazon equivalent is the s3fs that Ken mentioned I think.</p>
<p>@Ken &#8211; Good feedback, thanks! You must be hanging out for an elastic IP + ELB combo then!</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2442">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/cba39abf1ef93db461d79604e7e69088?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/cba39abf1ef93db461d79604e7e69088?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.comtrya.com/' rel='external nofollow' class='url'>David</a></cite>			</div>
			
			<a href="index.html#comment-2442" class="comment-date">
				<time datetime="2011-07-10T15:09:05+00:00">July 10, 2011</time>			</a>
		</div>
				<div id="div-comment-2442" class="comment-content">
				<div class="comment-text">
		<p>Very helpful post as I&#8217;ve been running around in circles it feels like trying to figure out why under a bit of load the micro instance I&#8217;m testing spikes CPU and becomes unresponsive. I&#8217;ve look for optimizations, especially for MySQL, with on too much change. Your statement about, </p>
<p>&#8220;The problem with a single micro instance was my site was going down when it came under sustained load on seldom visited pages. The CPU get’s capped after some (short) amount of time. &#8221;</p>
<p>And the link to Greg&#8217;s post make it more clear as to what is happening to the micro instance.</p>
<p>The MySQL access seems to responsible for the CPU spike and envoke the mico instance load-leveling to a severely limited amount CPU. Even using caching like W3TC might not help completely since it still needs to build the cached pages from the database each hour. And when less often accessed pages are cached (like when google bot indexed).</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2473">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9daa3f75da18bbf5c1cfe9116e7f4dc4?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9daa3f75da18bbf5c1cfe9116e7f4dc4?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://syymza.com/' rel='external nofollow' class='url'>Daniele Zanni</a></cite>			</div>
			
			<a href="index.html#comment-2473" class="comment-date">
				<time datetime="2011-07-25T19:50:54+00:00">July 25, 2011</time>			</a>
		</div>
				<div id="div-comment-2473" class="comment-content">
				<div class="comment-text">
		<p>Hi. I wanted to ask if you had ever thought of  having a master/slave configuration. I am trying to build something similar to what you did. Do you see any advantages between the 2 configurations?</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor even thread-even depth-1" id="comment-2475">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-2475" class="comment-date">
				<time datetime="2011-07-26T00:58:34+00:00">July 26, 2011</time>			</a>
		</div>
				<div id="div-comment-2475" class="comment-content">
				<div class="comment-text">
		<p>Hi,</p>
<p>The relative work that MySQL is doing on WordPress compared to what Apache is doing means that the DB server is not really working very hard on my setup. </p>
<p>I wouldn&#8217;t gain much benefit from offloading reads to one or more slaves, but your setup may vary. It would be worth doing some load testing and see if the CPU % usage on MySQL gets high during heavy loads. If so consider testing with a slave setup. </p>
<p>You could also move the DB onto it&#8217;s own host too, and consider a small or medium instance instead of a micro for it. I always prefer less moving parts.</p>
<p>The main reason I think you&#8217;d go with the master/slave DB server is for fault tolerance. You could have the slave server on warm standby, and auto-scale it in behind the MySQL endpoint if the master server stops responding. Your data loss would (should) be very low.</p>
<p>I&#8217;d be interested to hear what you decide on and how it works out for you.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2486">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9daa3f75da18bbf5c1cfe9116e7f4dc4?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9daa3f75da18bbf5c1cfe9116e7f4dc4?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://syymza.com/' rel='external nofollow' class='url'>Daniele Zanni</a></cite>			</div>
			
			<a href="index.html#comment-2486" class="comment-date">
				<time datetime="2011-07-28T19:14:18+00:00">July 28, 2011</time>			</a>
		</div>
				<div id="div-comment-2486" class="comment-content">
				<div class="comment-text">
		<p>I am currently going with a solution similar to the one you adopted. I had actually tried to put HyperDB for WordPress on, but I got worst performance than before. Lately I am running a db server who just handles all the db requests. As you were saying the CPU usage is quite slow, but I have to check if there&#8217;s any network bottleneck this way.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2614">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/6d68cd1d9e90a8c0a1987c64733ac1b1?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/6d68cd1d9e90a8c0a1987c64733ac1b1?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://ryanalberts.com/' rel='external nofollow' class='url'>Ryan</a></cite>			</div>
			
			<a href="index.html#comment-2614" class="comment-date">
				<time datetime="2011-09-11T08:49:46+00:00">September 11, 2011</time>			</a>
		</div>
				<div id="div-comment-2614" class="comment-content">
				<div class="comment-text">
		<p>Thanks so much for your post!</p>
<p>I am curious &#8211; how many slave nodes do you have?  Is it still pretty cheap with your setup?  I have one micro instance that is having the same issue of cpu going to 100% with crawlers.  I wanted to keep my cost low but still handle those cpu spikes and pay more when they happen by adding an extra slave.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2615">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/6d68cd1d9e90a8c0a1987c64733ac1b1?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/6d68cd1d9e90a8c0a1987c64733ac1b1?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://ryanalberts.com/' rel='external nofollow' class='url'>Ryan</a></cite>			</div>
			
			<a href="index.html#comment-2615" class="comment-date">
				<time datetime="2011-09-11T08:57:18+00:00">September 11, 2011</time>			</a>
		</div>
				<div id="div-comment-2615" class="comment-content">
				<div class="comment-text">
		<p>Forgot to ask.  Then does your master node never cap out with cpu issues.  Does this mean you have a micro instance for the master node and micro instances for the slaves?</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor even thread-even depth-1" id="comment-2647">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-2647" class="comment-date">
				<time datetime="2011-09-20T03:39:47+00:00">September 20, 2011</time>			</a>
		</div>
				<div id="div-comment-2647" class="comment-content">
				<div class="comment-text">
		<p>@Ryan. Yes micro for the master and normally 4 micros for the frontend slave cluster. Of the 4 frontends, 1 is an on demand, the other 3 are on spot pricing of ~2.5c/hour. I did that so that when the price of spot micros goes crazy, my cluster drops back to 1 on demand &#8211; if all are spot, then it drops to 0! The problem is (and it has happened several times) that the lone micro can face the CPU cap of doom, and the site goes down. I need to pair this approach with autoscaling, so that when micro spot price is high, the on demand instances kick in for the few hours they are needed, then get terminated once the spot micros can come back. But alas, that is a blog post for another day!</p>
<p>Also, the master node CPU usage is quite low, because it&#8217;s basically just DB and file server, and once the pages are all cached, the db is seldom hit, so mainly it&#8217;s a NFS server for the front ends. High bandwidth, low cpu &#8211; but intra-ec2-instance bandwidth is free (thankfully).</p>
<p>It&#8217;s cheaper than a medium or large instance, and my load testing indicated strong request throughput, but the extra moving parts of a cluster and upkeep, probably makes it only borderline worth while for production, as a hobby &#8211; it&#8217;s justifiable. if I take the next step and script the on-demand handling etc, then maybe it&#8217;d be robust enough.</p>
<p>In any case, if you try it, let me know how you get on.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2820">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/16f964b577fbae137c9f4f45423578a6?s=128&amp;d=mm&amp;r=g' srcset="http://1.gravatar.com/avatar/16f964b577fbae137c9f4f45423578a6?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.hadallerwebsolutions.com/' rel='external nofollow' class='url'>David Hadaller</a></cite>			</div>
			
			<a href="index.html#comment-2820" class="comment-date">
				<time datetime="2011-12-29T16:37:00+00:00">December 29, 2011</time>			</a>
		</div>
				<div id="div-comment-2820" class="comment-content">
				<div class="comment-text">
		<p>Just wanted to say thanks for the great post and for sharing your experiences!  I&#8217;m looking at putting together a similar high availability solution for WordPress and Drupal sites using Amazon&#8217;s services.  Will come back with questions and experiences if I go that route.  Thanks again! Dave</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2830">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/ce57fbe7a468722470d6383a58c4124b?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/ce57fbe7a468722470d6383a58c4124b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://ira.abramov.org/blog' rel='external nofollow' class='url'>Ira</a></cite>			</div>
			
			<a href="index.html#comment-2830" class="comment-date">
				<time datetime="2012-01-04T07:02:07+00:00">January 4, 2012</time>			</a>
		</div>
				<div id="div-comment-2830" class="comment-content">
				<div class="comment-text">
		<p>I&#8217;m just about to install such a cluster (more probably on linode than on EC2), and I&#8217;m using Chef cookbook for the deployment. Are you using Chef too? are your cookbooks public? I&#8217;m trying to reinvent as few wheels as possible&#8230; 🙂</p>
<p>BTW, I warmly recommend a comment email registration plug-in (like Automattic&#8217;s own JetPack for WordPress), it helps the conversation continue.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-2834">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-2834" class="comment-date">
				<time datetime="2012-01-06T22:49:46+00:00">January 6, 2012</time>			</a>
		</div>
				<div id="div-comment-2834" class="comment-content">
				<div class="comment-text">
		<p>Haven&#8217;t used chef, sounds interesting though.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2928">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/fa0b40ce4875238ebb9b1df4f622742c?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/fa0b40ce4875238ebb9b1df4f622742c?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.systemacorp.com/' rel='external nofollow' class='url'>Owen Ilagan</a></cite>			</div>
			
			<a href="index.html#comment-2928" class="comment-date">
				<time datetime="2012-02-05T22:22:20+00:00">February 5, 2012</time>			</a>
		</div>
				<div id="div-comment-2928" class="comment-content">
				<div class="comment-text">
		<p>We had a similar experience with a micro-instance but it turns out that installing apache on EC2 via yum with mod_proxy sets the server as an open proxy by default. Perhaps you should try restricting mod_proxy to work only for your domain.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3553">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Heiko</cite>			</div>
			
			<a href="index.html#comment-3553" class="comment-date">
				<time datetime="2012-03-13T06:46:49+00:00">March 13, 2012</time>			</a>
		</div>
				<div id="div-comment-3553" class="comment-content">
				<div class="comment-text">
		<p>Hi Ashley,</p>
<p>could you give me a hint on how to setup the data sharing? If I get you right I need to set the bind-address in my.cnf to the private ip-address. But the private ip-address changes every time if I restart an instance.</p>
<p>Regards<br />
Heiko</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3562">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='../../../../index.html' rel='external nofollow' class='url'>ashley</a></cite>			</div>
			
			<a href="index.html#comment-3562" class="comment-date">
				<time datetime="2012-03-13T14:31:47+00:00">March 13, 2012</time>			</a>
		</div>
				<div id="div-comment-3562" class="comment-content">
				<div class="comment-text">
		<p>@Heiko &#8211; I say in the article &#8220;when an EC2 server resolves an elastic IP, they get the internal network interface&#8221; which I guess is a bit vague on second look.</p>
<p>Basically you want the front end nodes to refer to the DB host by the domain name of the elastic IP of the master node. That way when they resolve that domain name, they&#8217;ll get the internal network IP.</p>
<p>I&#8217;ll update that section of the article to make it clearer.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3568">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Heiko</cite>			</div>
			
			<a href="index.html#comment-3568" class="comment-date">
				<time datetime="2012-03-14T01:41:13+00:00">March 14, 2012</time>			</a>
		</div>
				<div id="div-comment-3568" class="comment-content">
				<div class="comment-text">
		<p>Hi Ashley,<br />
thanks for clearing this point. Your blog helps a lot to understand the different parts of aws and how they play together. Many thanks for that.<br />
I&#8217;m wondering why you don&#8217;t use RDS for your datasources.<br />
Heiko</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3569">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='../../../../index.html' rel='external nofollow' class='url'>Ashley</a></cite>			</div>
			
			<a href="index.html#comment-3569" class="comment-date">
				<time datetime="2012-03-14T01:49:33+00:00">March 14, 2012</time>			</a>
		</div>
				<div id="div-comment-3569" class="comment-content">
				<div class="comment-text">
		<p>Glad to hear it.</p>
<p>RDS is great, I just didn&#8217;t need a dedicated DB server for a small WordPress cluster. </p>
<p>The database is hardly doing any work. For difefrent applications, such as Magento it&#8217;d be ideal to use RDS, and the memcache server, so that the front end nodes can focus only on running the web app.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3781">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9f5831be4487097f1ba5b8a96054d1b9?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Heiko</cite>			</div>
			
			<a href="index.html#comment-3781" class="comment-date">
				<time datetime="2012-03-20T07:12:52+00:00">March 20, 2012</time>			</a>
		</div>
				<div id="div-comment-3781" class="comment-content">
				<div class="comment-text">
		<p>Hi Ashley,</p>
<p>with the help of your post I managed to put my TYPO3 Website on ec2 instances. Thanks a lot.<br />
One thing I came up with is that I had to open TCP-Ports in my security group for NFS. I&#8217;m wondering if I configured something wrong or did you also open TCP-Ports for NFS?</p>
<p>Regards<br />
Heiko</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3784">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='../../../../index.html' rel='external nofollow' class='url'>Ashley</a></cite>			</div>
			
			<a href="index.html#comment-3784" class="comment-date">
				<time datetime="2012-03-20T12:00:00+00:00">March 20, 2012</time>			</a>
		</div>
				<div id="div-comment-3784" class="comment-content">
				<div class="comment-text">
		<p>You have the ports open, but only for EC2 instances within the specific security group of your front end nodes. The EC2 firewall makes this part easy.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-4850">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/8cd6caf7a29cd8231b5a60b319712ed2?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/8cd6caf7a29cd8231b5a60b319712ed2?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://yourstoryclub.com/' rel='external nofollow' class='url'>Chief Editor</a></cite>			</div>
			
			<a href="index.html#comment-4850" class="comment-date">
				<time datetime="2012-06-23T11:01:38+00:00">June 23, 2012</time>			</a>
		</div>
				<div id="div-comment-4850" class="comment-content">
				<div class="comment-text">
		<p>Dear Ashley, excellent solution; I was looking exactly the same. However need step by step guidance for setting up master, slave instances and creating database and NFS server and client. Please give some leads. Thanks</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-4860">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9282d33eecd30c19c81c3b6272b74e8c?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/9282d33eecd30c19c81c3b6272b74e8c?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.appwheal.com/' rel='external nofollow' class='url'>John Wheal</a></cite>			</div>
			
			<a href="index.html#comment-4860" class="comment-date">
				<time datetime="2012-07-02T12:32:44+00:00">July 2, 2012</time>			</a>
		</div>
				<div id="div-comment-4860" class="comment-content">
				<div class="comment-text">
		<p>This is what I do for my site. The only difference is that I have a memcached server to handle PHP sessions.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-5235">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/fd9e8e18887fbd1fee300b749ca1dbbe?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/fd9e8e18887fbd1fee300b749ca1dbbe?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.tearecipe.org/' rel='external nofollow' class='url'>Larry</a></cite>			</div>
			
			<a href="index.html#comment-5235" class="comment-date">
				<time datetime="2012-11-28T04:58:34+00:00">November 28, 2012</time>			</a>
		</div>
				<div id="div-comment-5235" class="comment-content">
				<div class="comment-text">
		<p>Ashley, I have to applaud you on being one of the very few to actually think things through and have a viable aws scaling wordpress tutorial.  I&#8217;ve tried them all, with a real 1000 page blog, and almost all of them can&#8217;t run on a t1.micro &#8211; but your auto scaling solution does the trick.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor even thread-even depth-1" id="comment-5239">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-5239" class="comment-date">
				<time datetime="2012-11-28T11:15:21+00:00">November 28, 2012</time>			</a>
		</div>
				<div id="div-comment-5239" class="comment-content">
				<div class="comment-text">
		<p>Thanks Larry! Yes, the <a href="../../../../2012/01/using-aws-auto-scaling-with-an-elastic-load-balancer-cluster-on-ec2/index.html" rel="nofollow">autoscaling follow up to this post</a> is I think important, since adding that, and going on-demand, not spot, I have had a much more reliable site.</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-7393">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/8542e4e924dacc08e1df9aa3bcdcaeba?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/8542e4e924dacc08e1df9aa3bcdcaeba?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Larsen</cite>			</div>
			
			<a href="index.html#comment-7393" class="comment-date">
				<time datetime="2013-01-17T03:15:18+00:00">January 17, 2013</time>			</a>
		</div>
				<div id="div-comment-7393" class="comment-content">
				<div class="comment-text">
		<p>Hi Ashley,</p>
<p>thanks a lot for your blog post. I am just starting to learn about EC2 and still have some questions:</p>
<p>How is your storage organized? Do you use an EBS volume for your master instance and the slave instances use the data via NFS?</p>
<p>Do you have different AMIs for the master and the slaves?</p>
<p>Cheers<br />
Lars</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-9970">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5fc69e82118f3a0d3980bba35221bf71?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/5fc69e82118f3a0d3980bba35221bf71?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.liquidcompass.com/' rel='external nofollow' class='url'>Joe Cole</a></cite>			</div>
			
			<a href="index.html#comment-9970" class="comment-date">
				<time datetime="2013-04-04T12:59:32+00:00">April 4, 2013</time>			</a>
		</div>
				<div id="div-comment-9970" class="comment-content">
				<div class="comment-text">
		<p>Just a tip for anyone that doesn&#8217;t know much about MySQL.  I followed the steps in this blog post but still couldn&#8217;t connect to MySQL from neither my master node nor my web front-end node.  I kept getting a &#8220;Error establishing a database connection&#8221; error whenever I attempted to view my site in a browser.  After MUCH banging my head on the proverbial wall, I figured out that the TurnKey WordPress AMI I started with when I created my EC2 instances was set to bind MySQL to the loopback address AND the privileges for user root in the User table were restricting host to localhost only.</p>
<p>To resolve the error, I modified /etc/mysql/my.cnf and changed</p>
<p>bind-address		= 127.0.0.1<br />
to<br />
bind-address		= ec2-[elastic ip here with dashes].compute-1.amazonaws.com</p>
<p>So that fixed the binding issue.  To fix the permissions issue, I logged into MySQL as root on the console and added a new record to the User table in the mysql database as follows:</p>
<p>mysql -u root -p<br />
[password]<br />
GRANT ALL PRIVILEGES ON *.* TO &#8216;root&#8217;@&#8217;ip-%.ec2.internal&#8217; IDENTIFIED BY &#8216;[password]&#8217;;</p>
<p>This allows the root user to access MySQL from any host that starts with &#8220;ip-&#8221; and ends with &#8220;.ec2.internal&#8221;.  (FYI &#8211; I tested using telnet to see that the internal DNS name is what goes across the wire.</p>
<p>After those changes, I was able to connect to MySQL from both the master node and my web front-end nodes.</p>
<p>So if you&#8217;re using a 3rd-party AMI as your starting image and can&#8217;t connect to MySQL to save your life, check your /etc/mysql/my.cnf file and the mysql.User table!!</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-9972">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-9972" class="comment-date">
				<time datetime="2013-04-04T13:06:28+00:00">April 4, 2013</time>			</a>
		</div>
				<div id="div-comment-9972" class="comment-content">
				<div class="comment-text">
		<p>Joe, you have restored my faith in enabling comments, thanks for your contribution. </p>
<p><a href="https://twitter.com/aschroder/status/319918359200276481" rel="nofollow">https://twitter.com/aschroder/status/319918359200276481</a></p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

				<p class="no-comments">Comments are closed.</p>
	
</section><!-- #comments -->

</div><!-- #post-## -->

		</main><!-- #main -->
	</div><!-- #primary -->


		</div><!-- .col-full -->
	</div><!-- #content -->

	
	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="col-full">

					<div class="site-info">
			&copy; ASchroder.com 2023						<br /> Storefront designed by <a href="http://www.woocommerce.com/" title="WooCommerce - The Best eCommerce Platform for WordPress" rel="author">WooCommerce</a>.					</div><!-- .site-info -->
		
		</div><!-- .col-full -->
	</footer><!-- #colophon -->

	
</div><!-- #page -->

<link rel='stylesheet' id='yarppRelatedCss-css'  href='../../../../wp-content/plugins/yet-another-related-posts-plugin/style/related101e.css?ver=4.8.15' type='text/css' media='all' />
<script type='text/javascript' src='../../../../wp-content/plugins/wp-syntax/js/wp-syntax4963.js?ver=1.1'></script>
<script type='text/javascript' src='../../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/js/navigation.min11a8.js?ver=20120206'></script>
<script type='text/javascript' src='../../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/js/skip-link-focus-fix.min08e0.js?ver=20130115'></script>
<script type='text/javascript' src='../../../../../cdn.aschroder.com/wp-includes/js/wp-embed.min101e.js?ver=4.8.15'></script>

</body>

<!-- Mirrored from www.aschroder.com/2011/06/clustering-wordpress-on-amazon-ec2-micro-instances/comment-page-1/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 30 Aug 2023 22:39:32 GMT -->
</html>

<!-- Performance optimized by W3 Total Cache. Learn more: https://www.w3-edge.com/products/

Page Caching using disk
Content Delivery Network via cdn.aschroder.com

 Served from: www.aschroder.com @ 2023-08-30 14:32:30 by W3 Total Cache -->