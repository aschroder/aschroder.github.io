<!doctype html>
<html lang="en-US">

<!-- Mirrored from www.aschroder.com/2012/07/magento-ssl-offloading-with-amazon-elb/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 30 Aug 2023 22:32:04 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="../../../xmlrpc.php">

<title>Magento SSL Offloading with Amazon ELB | ASchroder.com</title>

<!-- All in One SEO Pack 2.4.2 by Michael Torbert of Semper Fi Web Design[289,356] -->
<meta name="description"  content="I&#039;ve sort of day working through this Magento SSL offload on Amazon&#039;s ELB and I thought it&#039;d be worth documenting what&#039;s involved, in the process I&#039;ll give some" />

<!-- /all in one seo pack -->
<link rel='dns-prefetch' href='http://fonts.googleapis.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Feed" href="../../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Comments Feed" href="../../../comments/feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="ASchroder.com &raquo; Magento SSL Offloading with Amazon ELB Comments Feed" href="feed/index.html" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v6.2.4 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<script type="text/javascript" data-cfasync="false">
		var disableStr = 'ga-disable-UA-6477134-1';

	/* Function to detect opted out users */
	function __gaTrackerIsOptedOut() {
		return document.cookie.indexOf(disableStr + '=true') > -1;
	}

	/* Disable tracking if the opt-out cookie exists. */
	if ( __gaTrackerIsOptedOut() ) {
		window[disableStr] = true;
	}

	/* Opt-out function */
	function __gaTrackerOptout() {
	  document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
	  window[disableStr] = true;
	}
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','http://www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-6477134-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	__gaTracker('send','pageview');
</script>
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.aschroder.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.8.15"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,56826,8203,55356,56819),0,0),c=j.toDataURL(),b!==c&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55358,56794,8205,9794,65039),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55358,56794,8203,9794,65039),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='yarppWidgetCss-css'  href='../../../wp-content/plugins/yet-another-related-posts-plugin/style/widget101e.css?ver=4.8.15' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='../../../wp-content/plugins/wp-syntax/css/wp-syntax4963.css?ver=1.1' type='text/css' media='all' />
<link rel='stylesheet' id='storefront-style-css'  href='../../../../cdn.aschroder.com/wp-content/themes/storefront/style5bf8.css?ver=2.2.5' type='text/css' media='all' />
<style id='storefront-style-inline-css' type='text/css'>

			.main-navigation ul li a,
			.site-title a,
			ul.menu li a,
			.site-branding h1 a,
			.site-footer .storefront-handheld-footer-bar a:not(.button),
			button.menu-toggle,
			button.menu-toggle:hover {
				color: #333333;
			}

			button.menu-toggle,
			button.menu-toggle:hover {
				border-color: #333333;
			}

			.main-navigation ul li a:hover,
			.main-navigation ul li:hover > a,
			.site-title a:hover,
			a.cart-contents:hover,
			.site-header-cart .widget_shopping_cart a:hover,
			.site-header-cart:hover > li > a,
			.site-header ul.menu li.current-menu-item > a {
				color: #838383;
			}

			table th {
				background-color: #f8f8f8;
			}

			table tbody td {
				background-color: #fdfdfd;
			}

			table tbody tr:nth-child(2n) td,
			fieldset,
			fieldset legend {
				background-color: #fbfbfb;
			}

			.site-header,
			.secondary-navigation ul ul,
			.main-navigation ul.menu > li.menu-item-has-children:after,
			.secondary-navigation ul.menu ul,
			.storefront-handheld-footer-bar,
			.storefront-handheld-footer-bar ul li > a,
			.storefront-handheld-footer-bar ul li.search .site-search,
			button.menu-toggle,
			button.menu-toggle:hover {
				background-color: #ffffff;
			}

			p.site-description,
			.site-header,
			.storefront-handheld-footer-bar {
				color: #6d6d6d;
			}

			.storefront-handheld-footer-bar ul li.cart .count,
			button.menu-toggle:after,
			button.menu-toggle:before,
			button.menu-toggle span:before {
				background-color: #333333;
			}

			.storefront-handheld-footer-bar ul li.cart .count {
				color: #ffffff;
			}

			.storefront-handheld-footer-bar ul li.cart .count {
				border-color: #ffffff;
			}

			h1, h2, h3, h4, h5, h6 {
				color: #333333;
			}

			.widget h1 {
				border-bottom-color: #333333;
			}

			body,
			.secondary-navigation a,
			.onsale,
			.pagination .page-numbers li .page-numbers:not(.current), .woocommerce-pagination .page-numbers li .page-numbers:not(.current) {
				color: #6d6d6d;
			}

			.widget-area .widget a,
			.hentry .entry-header .posted-on a,
			.hentry .entry-header .byline a {
				color: #9f9f9f;
			}

			a  {
				color: #0228d1;
			}

			a:focus,
			.button:focus,
			.button.alt:focus,
			.button.added_to_cart:focus,
			.button.wc-forward:focus,
			button:focus,
			input[type="button"]:focus,
			input[type="reset"]:focus,
			input[type="submit"]:focus {
				outline-color: #0228d1;
			}

			button, input[type="button"], input[type="reset"], input[type="submit"], .button, .added_to_cart, .widget a.button, .site-header-cart .widget_shopping_cart a.button {
				background-color: #eeeeee;
				border-color: #eeeeee;
				color: #333333;
			}

			button:hover, input[type="button"]:hover, input[type="reset"]:hover, input[type="submit"]:hover, .button:hover, .added_to_cart:hover, .widget a.button:hover, .site-header-cart .widget_shopping_cart a.button:hover {
				background-color: #d5d5d5;
				border-color: #d5d5d5;
				color: #333333;
			}

			button.alt, input[type="button"].alt, input[type="reset"].alt, input[type="submit"].alt, .button.alt, .added_to_cart.alt, .widget-area .widget a.button.alt, .added_to_cart, .widget a.button.checkout {
				background-color: #333333;
				border-color: #333333;
				color: #ffffff;
			}

			button.alt:hover, input[type="button"].alt:hover, input[type="reset"].alt:hover, input[type="submit"].alt:hover, .button.alt:hover, .added_to_cart.alt:hover, .widget-area .widget a.button.alt:hover, .added_to_cart:hover, .widget a.button.checkout:hover {
				background-color: #1a1a1a;
				border-color: #1a1a1a;
				color: #ffffff;
			}

			.pagination .page-numbers li .page-numbers.current, .woocommerce-pagination .page-numbers li .page-numbers.current {
				background-color: #e6e6e6;
				color: #6d6d6d;
			}

			#comments .comment-list .comment-content .comment-text {
				background-color: #f8f8f8;
			}

			.site-footer {
				background-color: #f0f0f0;
				color: #6d6d6d;
			}

			.site-footer a:not(.button) {
				color: #333333;
			}

			.site-footer h1, .site-footer h2, .site-footer h3, .site-footer h4, .site-footer h5, .site-footer h6 {
				color: #333333;
			}

			#order_review {
				background-color: #ffffff;
			}

			#payment .payment_methods > li .payment_box,
			#payment .place-order {
				background-color: #fafafa;
			}

			#payment .payment_methods > li:not(.woocommerce-notice) {
				background-color: #f5f5f5;
			}

			#payment .payment_methods > li:not(.woocommerce-notice):hover {
				background-color: #f0f0f0;
			}

			@media screen and ( min-width: 768px ) {
				.secondary-navigation ul.menu a:hover {
					color: #868686;
				}

				.secondary-navigation ul.menu a {
					color: #6d6d6d;
				}

				.site-header-cart .widget_shopping_cart,
				.main-navigation ul.menu ul.sub-menu,
				.main-navigation ul.nav-menu ul.children {
					background-color: #f0f0f0;
				}

				.site-header-cart .widget_shopping_cart .buttons,
				.site-header-cart .widget_shopping_cart .total {
					background-color: #f5f5f5;
				}

				.site-header {
					border-bottom-color: #f0f0f0;
				}
			}
</style>
<link rel='stylesheet' id='storefront-icons-css'  href='../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/sass/base/icons5bf8.css?ver=2.2.5' type='text/css' media='all' />
<link rel='stylesheet' id='storefront-fonts-css'  href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,300italic,400italic,600,700,900&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<script type='text/javascript' src='../../../../cdn.aschroder.com/wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../../../cdn.aschroder.com/wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Opening (and closing) jQuery Mobile Collapsible sections programatically' href='../opening-and-closing-jquery-mobile-collapsible-sections-programatically/index.html' />
<link rel='next' title='An Open Twitter-like Network, Powered by Email.' href='../an-open-twitter-like-network-powered-by-email/index.html' />
<meta name="generator" content="WordPress 4.8.15" />
<link rel="canonical" href="index.html" />
<link rel='shortlink' href='../../../index1406.html?p=1792' />
<link rel="alternate" type="application/json+oembed" href="../../../wp-json/oembed/1.0/embedeb00.json?url=http%3A%2F%2Fwww.aschroder.com%2F2012%2F07%2Fmagento-ssl-offloading-with-amazon-elb%2F" />
<link rel="alternate" type="text/xml+oembed" href="../../../wp-json/oembed/1.0/embed8505?url=http%3A%2F%2Fwww.aschroder.com%2F2012%2F07%2Fmagento-ssl-offloading-with-amazon-elb%2F&amp;format=xml" />
</head>

<body class="post-template-default single single-post postid-1792 single-format-standard no-wc-breadcrumb storefront-full-width-content right-sidebar">


<div id="page" class="hfeed site">
	
	<header id="masthead" class="site-header" role="banner" style="">
		<div class="col-full">

					<a class="skip-link screen-reader-text" href="#site-navigation">Skip to navigation</a>
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
				<div class="site-branding">
			<div class="beta site-title"><a href="../../../index.html" rel="home">ASchroder.com</a></div><p class="site-description">Notes on Web Development</p>		</div>
		<div class="storefront-primary-navigation">		<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Navigation">
		<button class="menu-toggle" aria-controls="site-navigation" aria-expanded="false"><span>Menu</span></button>
			<div class="primary-navigation"><ul id="menu-main-menu" class="menu"><li id="menu-item-1119" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1119"><a href="../../../index.html">Home</a></li>
<li id="menu-item-1118" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1118"><a href="../../../about/index.html">About</a></li>
<li id="menu-item-1872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1872"><a href="../../../presentations/index.html">Presentations</a></li>
</ul></div><div class="handheld-navigation"><ul id="menu-main-menu-1" class="menu"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1119"><a href="../../../index.html">Home</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1118"><a href="../../../about/index.html">About</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1872"><a href="../../../presentations/index.html">Presentations</a></li>
</ul></div>		</nav><!-- #site-navigation -->
		</div>
		</div>
	</header><!-- #masthead -->

	
	<div id="content" class="site-content" tabindex="-1">
		<div class="col-full">

		
	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
<div id="post-1792" class="post-1792 post type-post status-publish format-standard hentry category-apache category-magento category-web-development tag-amnazon tag-apache tag-aws tag-ec2 tag-elb tag-magetno">

			<header class="entry-header">
		<span class="posted-on">Posted on <a href="index.html" rel="bookmark"><time class="entry-date published" datetime="2012-07-17T22:33:07+00:00">July 17, 2012</time> <time class="updated" datetime="2012-07-18T02:25:00+00:00">July 18, 2012</time></a></span><h1 class="entry-title">Magento SSL Offloading with Amazon ELB</h1>		</header><!-- .entry-header -->
				<aside class="entry-meta">
						<div class="author">
				<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' /><div class="label">Written by</div><a href="../../../author/admin/index.html" title="Posts by Ashley" rel="author">Ashley</a>			</div>
							<div class="cat-links">
					<div class="label">Posted in</div><a href="../../../category/apache/index.html" rel="category tag">Apache</a>, <a href="../../../category/magento/index.html" rel="category tag">Magento</a>, <a href="../../../category/web-development/index.html" rel="category tag">Web Development</a>				</div>
			
							<div class="tags-links">
					<div class="label">Tagged</div><a href="../../../tag/amnazon/index.html" rel="tag">amnazon</a>, <a href="../../../tag/apache/index.html" rel="tag">Apache</a>, <a href="../../../tag/aws/index.html" rel="tag">aws</a>, <a href="../../../tag/ec2/index.html" rel="tag">ec2</a>, <a href="../../../tag/elb/index.html" rel="tag">elb</a>, <a href="../../../tag/magetno/index.html" rel="tag">magetno</a>				</div>
			
		
							<div class="comments-link">
					<div class="label">Comments</div>					<span class="comments-link"><a href="index.html#comments">10 Comments</a></span>
				</div>
					</aside>
				<div class="entry-content">
		<p>I&#8217;ve <a href="https://twitter.com/aschroder/status/225457612014108672">had a <em>fun &#038; games</em> sort of day</a> working through this Magento SSL offload on Amazon&#8217;s ELB and I thought it&#8217;d be worth documenting what&#8217;s involved, in the process I&#8217;ll give some steps to get it working and explain what the new (since version 1.6.2) <code>Offloader header</code> config option is for and how it helps.</p>
<h3>Background</h3>
<p>Firstly, a bit of background &#8211; if you just want the quick fix, <a href="#quickfix">skip right to it</a>. The <em>Internet</em> can beam magically onto your computer screen one of two ways: <code><a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">http</a></code> and <code><a href="http://en.wikipedia.org/wiki/HTTP_Secure">https</a></code>. <code>http</code> means the things you see everyone else can see too, the content is unencrypted and sent from the server to your computer. If you&#8217;re at a wifi hotspot, what you do online is being broadcast to everyone around you. Conversely, an <code>https</code> connection means the content is securely encrypted, and the endpoint server you are connecting to, is probably who they say they are. So we want https in public places, or when financial or personal information is involved &#8211; and if we&#8217;re paranoid, we want it all the time.<br />
<span id="more-1792"></span><br />
But, the SSL encryption has to be processed by the server, and that takes server cycles (albeit not many). One technique to reduce the work your Magento server is doing is to offload the SSL processing to a server in front of your Magento server(s) &#8211; this is called SSL offloading. SSL Offloading can be handled by a large number of proxy servers (Apache and Nginx to name two) &#8211; we run our stores on Amazon&#8217;s EC2 and have access to the SSL offload capability of their ELB load balancer, which is what I will walk through here.</p>
<p>I drew a diagram on paper for you.<br />
<img src="../../../../cdn.aschroder.com/wp-content/uploads/2012/07/ELB-diagram1.jpg" alt="ELB SSL Offload diagram" title="ELB SSL Offload diagram" width="500" height="667" class="aligncenter size-full wp-image-1795" srcset="http://cdn.aschroder.com/wp-content/uploads/2012/07/ELB-diagram1.jpg 500w, http://cdn.aschroder.com/wp-content/uploads/2012/07/ELB-diagram1-224x300.jpg 224w" sizes="(max-width: 500px) 100vw, 500px" /></p>
<p>What you can see is the secure connection arrives on port 443 to the ELB load balancer, and then on the Amazon internal network, the connection becomes plain http on port 80 and is passed to the Magento cluster for processing. This means the Magento servers only do the work as if a plain http connection had been used.</p>
<h3>The problem</h3>
<p>There&#8217;s a problem with this though. Magento (or indeed any application in a similar arrangement) will think the connection is not secure right through to the user. This means if Magento has been configured to force secure URL&#8217;s (in say the admin, or frontend) it will redirect the user to the https: portion of the site, but it is already on it &#8211; and so we get an infinite redirect loop. The flipside, if Magento is not configured to force SSL, is that it will write url&#8217;s to the non-secure base url (http) because it thinks the original request is on http. This will result in most browsers warning the user about mixed SSL and non SSL-content &#8211; which can scare users away. So neither scenario is really very desirable.</p>
<p>The solution has actually existed for ages, the SSL Offloader can pass a message to the destination server by way of an additional HTTP header &#8211; the application can interpret it and will then know the connection is secure, great! Magento supports this check in two ways. Initially it just checks for a header of <code>HTTPS</code> that&#8217;s not &#8216;off&#8217;. For non-standard setups, as of version 1.6.2 you can now specify you own header which if populated, will be interpreted by Magento to mean the connection is secure regardless of which protocol it arrived on. </p>
<p>This is the relevant code:</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="php" style="font-family:monospace;">    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">function</span> isCurrentlySecure<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        <span style="color: #000088;">$standardRule</span> <span style="color: #339933;">=</span> <span style="color: #339933;">!</span><span style="color: #990000;">empty</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'HTTPS'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'off'</span> <span style="color: #339933;">!=</span> <span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'HTTPS'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000088;">$offloaderHeader</span> <span style="color: #339933;">=</span> <span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>string<span style="color: #009900;">&#41;</span> Mage<span style="color: #339933;">::</span><span style="color: #004000;">getConfig</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">getNode</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">self</span><span style="color: #339933;">::</span><span style="color: #004000;">XML_PATH_OFFLOADER_HEADER</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'default'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #990000;">empty</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$offloaderHeader</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span><span style="color: #990000;">empty</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$offloaderHeader</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">||</span> <span style="color: #000088;">$standardRule</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            <span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">true</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
<span style="color: #666666; font-style: italic;">// ...</span>
    <span style="color: #009900;">&#125;</span></pre></td></tr></table><p class="theCode" style="display:none;">    public function isCurrentlySecure()
    {
        $standardRule = !empty($_SERVER['HTTPS']) &amp;&amp; ('off' != $_SERVER['HTTPS']);
        $offloaderHeader = trim((string) Mage::getConfig()-&gt;getNode(self::XML_PATH_OFFLOADER_HEADER, 'default'));

        if ((!empty($offloaderHeader) &amp;&amp; !empty($_SERVER[$offloaderHeader])) || $standardRule) {
            return true;
        }
// ...
    }</p></div>

<p>The problem is that Amazon&#8217;s AWS doesn&#8217;t send a header with the semantics of <em>if it&#8217;s present, it&#8217;s secure</em> which is what Magento is coded to assume. Instead, <a href="http://aws.typepad.com/aws/2010/10/keeping-customers-happy-another-new-elastic-load-balancer-feature.html">ELB sends two headers</a>, one telling you what protocol, and another telling you what port.</p>
<p><a name="quickfix"></a></p>
<h3>How to fix it?</h3>
<p>We <em>could</em> modify Magento so that it can handle different header semantics, but modifying Magento should be your absolute last resort, trust me. We can achieve a much simpler victory by just adding a simple <code>SetEnvIf</code> Apache directive (assuming you use Apache) to check for the header that Amazon&#8217;s ELB uses, and set the header that Magento is expecting.</p>

<div class="wp_syntax" style="position:relative;"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;"># Detect the ELB header and set the header magento expects</span>
SetEnvIf X-Forwarded-Proto https <span style="color: #007800;">HTTPS</span>=on</pre></td></tr></table><p class="theCode" style="display:none;"># Detect the ELB header and set the header magento expects
SetEnvIf X-Forwarded-Proto https HTTPS=on</p></div>

<p>With that in either your Apache server config your your <code>.htaccess</code> file, you should be good to go. </p>
<p>Note: In this article I haven&#8217;t covered actually getting the SSL, and setting it up for AWS. It can all be done through the web management console now, <a href="http://stackoverflow.com/questions/6753619/how-do-i-setup-ssl-certs-on-amazon-aws-load-balancer-using-godaddy-certificates">this is a good overview from StackOverflow</a> to get you started with the openssl commands, etc. If there&#8217;s enough interest, I&#8217;ll do a full walk through post &#8211; let me know.</p>
<div class='yarpp-related'>
<p>You might also be interested in:<ol>
<li><a href="../../../2011/05/magento-and-amazons-cloudfront-cdn-the-easy-way/index.html" rel="bookmark" title="Magento and Amazon&#8217;s CloudFront CDN &#8211; The Easy Way">Magento and Amazon&#8217;s CloudFront CDN &#8211; The Easy Way </a></li>
<li><a href="../../../2009/03/a-simple-way-to-password-protect-your-magento-store/index.html" rel="bookmark" title="A simple way to password protect your Magento store">A simple way to password protect your Magento store </a></li>
<li><a href="../../../2013/04/actually-running-magento-on-amazons-elastic-beanstalk-cloud-platform/index.html" rel="bookmark" title="Actually running Magento on Amazon&#8217;s Elastic Beanstalk Cloud platform">Actually running Magento on Amazon&#8217;s Elastic Beanstalk Cloud platform </a></li>
<li><a href="../../../2009/05/fixing-magento-login-problem-after-a-fresh-installation/index.html" rel="bookmark" title="Fixing Magento Login Problem after a Fresh Installation">Fixing Magento Login Problem after a Fresh Installation </a></li>
<li><a href="../../../2009/05/using-gmail-or-google-apps-email-with-magento/index.html" rel="bookmark" title="Using Gmail or Google Apps email with Magento">Using Gmail or Google Apps email with Magento </a></li>
</ol></p>
</div>
		</div><!-- .entry-content -->
		<nav id="post-navigation" class="navigation post-navigation" role="navigation" aria-label="Post Navigation"><span class="screen-reader-text">Post navigation</span><div class="nav-links"><div class="nav-previous"><a href="../opening-and-closing-jquery-mobile-collapsible-sections-programatically/index.html" rel="prev">Opening (and closing) jQuery Mobile Collapsible sections programatically</a></div><div class="nav-next"><a href="../an-open-twitter-like-network-powered-by-email/index.html" rel="next">An Open Twitter-like Network, Powered by Email.</a></div></div></nav>
<section id="comments" class="comments-area" aria-label="Post Comments">

			<h2 class="comments-title">
			10 thoughts on &ldquo;<span>Magento SSL Offloading with Amazon ELB</span>&rdquo;		</h2>

		
		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-4883">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/c8ce4acd532807e2183fa91ef98c3f91?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/c8ce4acd532807e2183fa91ef98c3f91?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://sergeif.me/' rel='external nofollow' class='url'>Sergei Filippov</a></cite>			</div>
			
			<a href="index.html#comment-4883" class="comment-date">
				<time datetime="2012-07-18T02:07:37+00:00">July 18, 2012</time>			</a>
		</div>
				<div id="div-comment-4883" class="comment-content">
				<div class="comment-text">
		<p>Awesome post Ashley. Will save this one for leter use. =]</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-4898">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/db8616252b467a038a73aba5c5d2a15e?s=128&amp;d=mm&amp;r=g' srcset="http://1.gravatar.com/avatar/db8616252b467a038a73aba5c5d2a15e?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Chris</cite>			</div>
			
			<a href="index.html#comment-4898" class="comment-date">
				<time datetime="2012-07-25T04:04:49+00:00">July 25, 2012</time>			</a>
		</div>
				<div id="div-comment-4898" class="comment-content">
				<div class="comment-text">
		<p>Spot on mate, been trying to work this out for weeks!</p>
<p>Cheers</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-4900">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/c8b42f151bd60a99c17112e71ca452dc?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/c8b42f151bd60a99c17112e71ca452dc?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Jun</cite>			</div>
			
			<a href="index.html#comment-4900" class="comment-date">
				<time datetime="2012-07-25T15:46:35+00:00">July 25, 2012</time>			</a>
		</div>
				<div id="div-comment-4900" class="comment-content">
				<div class="comment-text">
		<p>I&#8217;m currently setting up our magento website in Amazon and after setting up SSL on Amazon ELB and when using a simple html file, I can see that SSL is working (since the padlock icon is seen in firefox browser). But when I check the Magento website&#8217;s checkout page I&#8217;m not seeing the padlock icon, check this out:</p>
<p><a href="https://www.leluv.xxx/amazon-check.html" rel="nofollow">https://www.leluv.xxx/amazon-check.html</a><br />
vs:<br />
<a href="https://www.leluv.xxx/checkout/cart/" rel="nofollow">https://www.leluv.xxx/checkout/cart/</a></p>
<p>So far I already added the below line to .htaccess file, is there anything else I need to do to make this works? THANKS IN ADVANCE..</p>
<p>SetEnvIf X-Forwarded-Proto https HTTPS=on</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-4901">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-4901" class="comment-date">
				<time datetime="2012-07-25T15:54:21+00:00">July 25, 2012</time>			</a>
		</div>
				<div id="div-comment-4901" class="comment-content">
				<div class="comment-text">
		<p>Looks fine to me, Magento is emitting the https URL&#8217;s that it should.</p>
<p>You just need to fix up the absolute URL&#8217;s you&#8217;re using on the footer, e.g:<br />
<a href="http://www.leluv.xxx/skin/frontend/default/default/images/credit-card-new.png" rel="nofollow">http://www.leluv.xxx/skin/frontend/default/default/images/credit-card-new.png</a></p>
<p>View the page source, or inspect it with Chrome inspector or Firebug to see which resources are being loaded without https.</p>
<p>These url&#8217;s are probably hard coded in your theme/template files. Fire your Magento developer and get a good one ðŸ˜›</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-4986">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/f232a7d65db601effe3da742bc0a2958?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/f232a7d65db601effe3da742bc0a2958?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Vince</cite>			</div>
			
			<a href="index.html#comment-4986" class="comment-date">
				<time datetime="2012-09-13T02:51:23+00:00">September 13, 2012</time>			</a>
		</div>
				<div id="div-comment-4986" class="comment-content">
				<div class="comment-text">
		<p>SetEnvIf X-Forwarded-Proto https HTTPS=on can&#8217;t work since you can&#8217;t use an environnement variable in the condition statement.$*</p>
<p>Read Apache doc here : <a href="http://httpd.apache.org/docs/2.2/mod/mod_setenvif.html" rel="nofollow">http://httpd.apache.org/docs/2.2/mod/mod_setenvif.html</a></p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-4992">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/29dbad2c1a21916b69ff05e64c16b23b?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Ashley</cite>			</div>
			
			<a href="index.html#comment-4992" class="comment-date">
				<time datetime="2012-09-15T23:35:00+00:00">September 15, 2012</time>			</a>
		</div>
				<div id="div-comment-4992" class="comment-content">
				<div class="comment-text">
		<p>Weird&#8230;working fine for me. Maybe depends on Apache version? In any case, best to test this in <em>dev</em> before you release it (that goes without saying, right?)</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-5305">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/626ade3cb9621e09060076df9423d57c?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/626ade3cb9621e09060076df9423d57c?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://www.pi3g.com/' rel='external nofollow' class='url'>Max</a></cite>			</div>
			
			<a href="index.html#comment-5305" class="comment-date">
				<time datetime="2012-12-20T01:39:53+00:00">December 20, 2012</time>			</a>
		</div>
				<div id="div-comment-5305" class="comment-content">
				<div class="comment-text">
		<p>Hello Ashley,<br />
thanks for the information and description. I&#8217;ve identified another issue which I describe here in my blogpost as Step 2. Might help some users. Step 3 is the same as yours.</p>
<p><a href="http://blog.ideaday.de/max/2012/12/magento-https-redirect-loop-ssl-offloading-proxies-pound-nginx/" rel="nofollow">http://blog.ideaday.de/max/2012/12/magento-https-redirect-loop-ssl-offloading-proxies-pound-nginx/</a></p>
<p>Have a nice day!<br />
Max</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-7596">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7ac6d928c985594523e30199ab125eca?s=128&amp;d=mm&amp;r=g' srcset="http://1.gravatar.com/avatar/7ac6d928c985594523e30199ab125eca?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">robbyt</cite>			</div>
			
			<a href="index.html#comment-7596" class="comment-date">
				<time datetime="2013-01-18T22:16:54+00:00">January 18, 2013</time>			</a>
		</div>
				<div id="div-comment-7596" class="comment-content">
				<div class="comment-text">
		<p>Great post! Thank you!!!</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-9720">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/0fd34281dbef662e67698849e4dbb55a?s=128&amp;d=mm&amp;r=g' srcset="http://0.gravatar.com/avatar/0fd34281dbef662e67698849e4dbb55a?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn">Jay</cite>			</div>
			
			<a href="index.html#comment-9720" class="comment-date">
				<time datetime="2013-02-25T19:24:08+00:00">February 25, 2013</time>			</a>
		</div>
				<div id="div-comment-9720" class="comment-content">
				<div class="comment-text">
		<p>For NGINX, I used the following:</p>
<p>Within the server block:<br />
# Check if Load Balancer handled SSL<br />
set $my_https &#8220;off&#8221;;<br />
if ($http_x_forwarded_proto = &#8220;https&#8221;) {<br />
        set $my_https &#8220;on&#8221;;<br />
}</p>
<p>I then added with the rest of the fastcgi params:<br />
fastcgi_param HTTPS $my_https;</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-9723">
		<div class="comment-body">
		<div class="comment-meta commentmetadata">
			<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/842241123761ac10f2d511c7da60cd6f?s=128&amp;d=mm&amp;r=g' srcset="http://2.gravatar.com/avatar/842241123761ac10f2d511c7da60cd6f?s=256&amp;d=mm&amp;r=g 2x" class='avatar avatar-128 photo' height='128' width='128' />			<cite class="fn"><a href='http://globalworks.com/' rel='external nofollow' class='url'>josh belke</a></cite>			</div>
			
			<a href="index.html#comment-9723" class="comment-date">
				<time datetime="2013-02-27T15:35:20+00:00">February 27, 2013</time>			</a>
		</div>
				<div id="div-comment-9723" class="comment-content">
				<div class="comment-text">
		<p>index.php</p>
<p>above Mage::run($mageRunCode, $mageRunType);</p>
<p>try the following:</p>
<p>if (isset($_SERVER[&#8216;HTTP_X_FORWARDED_PROTO&#8217;]) &amp;&amp; $_SERVER[&#8216;HTTP_X_FORWARDED_PROTO&#8217;] == &#8216;https&#8217;) {<br />
    $_SERVER[&#8216;HTTPS&#8217;] = &#8216;on&#8217;;<br />
    $_SERVER[&#8216;SERVER_PORT&#8217;] = 443;<br />
}</p>
		</div>
		<div class="reply">
						</div>
		</div>
				</div>
			</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

				<p class="no-comments">Comments are closed.</p>
	
</section><!-- #comments -->

</div><!-- #post-## -->

		</main><!-- #main -->
	</div><!-- #primary -->


		</div><!-- .col-full -->
	</div><!-- #content -->

	
	<footer id="colophon" class="site-footer" role="contentinfo">
		<div class="col-full">

					<div class="site-info">
			&copy; ASchroder.com 2023						<br /> Storefront designed by <a href="http://www.woocommerce.com/" title="WooCommerce - The Best eCommerce Platform for WordPress" rel="author">WooCommerce</a>.					</div><!-- .site-info -->
		
		</div><!-- .col-full -->
	</footer><!-- #colophon -->

	
</div><!-- #page -->

<link rel='stylesheet' id='yarppRelatedCss-css'  href='../../../wp-content/plugins/yet-another-related-posts-plugin/style/related101e.css?ver=4.8.15' type='text/css' media='all' />
<script type='text/javascript' src='../../../wp-content/plugins/wp-syntax/js/wp-syntax4963.js?ver=1.1'></script>
<script type='text/javascript' src='../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/js/navigation.min11a8.js?ver=20120206'></script>
<script type='text/javascript' src='../../../../cdn.aschroder.com/wp-content/themes/storefront/assets/js/skip-link-focus-fix.min08e0.js?ver=20130115'></script>
<script type='text/javascript' src='../../../../cdn.aschroder.com/wp-includes/js/wp-embed.min101e.js?ver=4.8.15'></script>

</body>

<!-- Mirrored from www.aschroder.com/2012/07/magento-ssl-offloading-with-amazon-elb/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 30 Aug 2023 22:32:09 GMT -->
</html>

<!-- Performance optimized by W3 Total Cache. Learn more: https://www.w3-edge.com/products/

Page Caching using disk
Content Delivery Network via cdn.aschroder.com

 Served from: www.aschroder.com @ 2023-08-30 14:20:58 by W3 Total Cache -->